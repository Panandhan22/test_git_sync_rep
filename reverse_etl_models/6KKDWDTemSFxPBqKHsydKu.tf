import {
  to = segment_reverse_etl_model.id-6KKDWDTemSFxPBqKHsydKu
  id = "6KKDWDTemSFxPBqKHsydKu"
}

resource "segment_reverse_etl_model" "id-6KKDWDTemSFxPBqKHsydKu" {
  description             = " "
  enabled                 = true
  name                    = "priya_test+braze"
  query                   = "WITH clean_extract AS (\n  SELECT\n    f.id AS event_id,\n    FORMAT_TIMESTAMP('%Y-%m-%dT%H:%M:%S.%3SZ', TIMESTAMP(f.webhook_send_time)) AS webhook_send_time,\n    type AS event_type,\n    JSON_EXTRACT_SCALAR(`user`, '$.user.id') AS sso_id,\n    LOWER(TRIM(JSON_EXTRACT_SCALAR(`user`, '$.user.email'))) AS email,\n    TO_HEX(SHA256(LOWER(TRIM(JSON_EXTRACT_SCALAR(`user`, '$.user.email'))))) AS anonymous_id,\n    LOWER(JSON_EXTRACT_SCALAR(`user`, '$.user.firstName')) AS first_name,\n    LOWER(JSON_EXTRACT_SCALAR(`user`, '$.user.lastName')) AS last_name,\n    LOWER(TRIM(JSON_EXTRACT_SCALAR(`user`, '$.user.data.Country'))) AS incoming_country,\n    CASE\n      WHEN NULLIF(TRIM(JSON_EXTRACT_SCALAR(`user`, '$.user.birthDate')), '') IS NULL THEN NULL\n      ELSE CASE\n              WHEN SAFE_CAST(NULLIF(TRIM(JSON_EXTRACT_SCALAR(`user`, '$.user.birthDate')), '') AS DATE) IS NULL THEN NULL\n              WHEN SAFE_CAST(NULLIF(TRIM(JSON_EXTRACT_SCALAR(`user`, '$.user.birthDate')), '') AS DATE) > CURRENT_DATE THEN NULL\n              WHEN SAFE_CAST(NULLIF(TRIM(JSON_EXTRACT_SCALAR(`user`, '$.user.birthDate')), '') AS DATE) < DATE_SUB(CURRENT_DATE, INTERVAL 100 YEAR) THEN NULL\n              WHEN EXTRACT(YEAR FROM SAFE_CAST(NULLIF(TRIM(JSON_EXTRACT_SCALAR(`user`, '$.user.birthDate')), '') AS DATE)) < 1900 THEN NULL\n              ELSE SAFE_CAST(NULLIF(TRIM(JSON_EXTRACT_SCALAR(`user`, '$.user.birthDate')), '') AS DATE)\n           END\n    END AS birthday,\n    CASE\n      WHEN CAST(JSON_EXTRACT_SCALAR(`user`, '$.user.lastUpdateInstant') AS INT64) = 0 THEN NULL\n      ELSE TIMESTAMP_MICROS(CAST(JSON_EXTRACT_SCALAR(`user`, '$.user.lastUpdateInstant') AS INT64) * 1000)\n    END AS last_update_ts,\n    cc.code AS country_code,\n    LOWER(cc.continent) AS continent,\n    CAST(JSON_EXTRACT_SCALAR(`user`, '$.user.verified') AS BOOLEAN) AS is_verified,\n    CAST(JSON_EXTRACT_SCALAR(`user`, '$.user.data.CalculatedMarketingOptIn') AS BOOLEAN) AS email_marketing_preference,\n    CAST(JSON_EXTRACT_SCALAR(`user`, '$.user.data.CalculatedMarketingNewsOptIn') AS BOOLEAN) AS news_subscription_group,\n    CAST(JSON_EXTRACT_SCALAR(`user`, '$.user.data.CalculatedMarketingPartnersOptIn') AS BOOLEAN) AS partners_subscription_group,\n    CAST(JSON_EXTRACT_SCALAR(`user`, '$.user.data.CalculatedMarketingTicketingOptIn') AS BOOLEAN) AS ticketing_subscription_group,\n    CAST(JSON_EXTRACT_SCALAR(`user`, '$.user.data.CalculatedMarketingChelseaWomenOptIn') AS BOOLEAN) AS womens_subscription_group\n  FROM `cfc-business-data-prod.presentation_segment.fusionauth_webhook_table` f\n  LEFT JOIN `cfc-business-data-prod.utilities.country_continent_codes` cc\n    ON LOWER(cc.variant) = LOWER(TRIM(JSON_EXTRACT_SCALAR(`user`, '$.user.data.Country')))\n       OR LOWER(cc.code) = LOWER(TRIM(JSON_EXTRACT_SCALAR(`user`, '$.user.data.Country')))\n       OR LOWER(cc.iso) = LOWER(TRIM(JSON_EXTRACT_SCALAR(`user`, '$.user.data.Country')))\n  WHERE TIMESTAMP(f.webhook_send_time) >= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 20 MINUTE)\n    AND type IN (\"UserCreated\", \"UserUpdated\", \"EmailVerified\", \"export\")\n  QUALIFY ROW_NUMBER() OVER (\n    PARTITION BY f.id\n    ORDER BY\n      CASE\n        WHEN LOWER(cc.variant) = LOWER(TRIM(JSON_EXTRACT_SCALAR(`user`, '$.user.data.Country'))) THEN 1\n        WHEN LOWER(cc.code) = LOWER(TRIM(JSON_EXTRACT_SCALAR(`user`, '$.user.data.Country'))) THEN 2\n        WHEN LOWER(cc.iso) = LOWER(TRIM(JSON_EXTRACT_SCALAR(`user`, '$.user.data.Country'))) THEN 3\n        ELSE 4\n      END\n  ) = 1\n),\nemails_with_only_one_sso_id AS (\n  SELECT\n    LOWER(TRIM(JSON_EXTRACT_SCALAR(`user`, '$.user.email'))) AS email,\n    COUNT(DISTINCT JSON_EXTRACT_SCALAR(`user`, '$.user.id')) AS sso_count\n  FROM `cfc-business-data-prod.presentation_segment.fusionauth_webhook_table`\n  WHERE LOWER(TRIM(JSON_EXTRACT_SCALAR(`user`, '$.user.email'))) IS NOT NULL\n    AND type IN (\"UserCreated\", \"UserUpdated\", \"UserLogin\", \"EmailVerified\", \"export\")\n    AND JSON_EXTRACT_SCALAR(`user`, '$.user.id') NOT IN (\n      SELECT DISTINCT sso_id FROM `cfc-business-data-prod.transform_fusionauth.fusionauth_deleted_user_accounts`\n    )\n  GROUP BY LOWER(TRIM(JSON_EXTRACT_SCALAR(`user`, '$.user.email')))\n  HAVING sso_count = 1\n)\n\nSELECT\n  event_id,\n  webhook_send_time,\n  event_type,\n  sso_id,\n  clean_extract.email,\n  anonymous_id,\n  first_name,\n  last_name,\n  birthday,\n  CASE\n    WHEN birthday IS NULL THEN NULL\n    WHEN NOT REGEXP_CONTAINS(CAST(birthday AS STRING), r'^(19|20|21|22)\\d{2}-(0?[1-9]|1[0-2])-(0?[1-9]|[12]\\d|3[01])$') THEN NULL\n    ELSE\n      CASE\n        WHEN DATE_DIFF(CURRENT_DATE(), DATE(birthday), YEAR)\n               - CASE\n                   WHEN FORMAT_DATE('%m%d', DATE(birthday)) > FORMAT_DATE('%m%d', CURRENT_DATE()) THEN 1\n                   ELSE 0\n                 END > 16 THEN TRUE\n        ELSE FALSE\n      END\n  END AS over_16,\n  CASE\n    WHEN birthday IS NULL THEN NULL\n    WHEN NOT REGEXP_CONTAINS(CAST(birthday AS STRING), r'^(19|20|21|22)\\d{2}-(0?[1-9]|1[0-2])-(0?[1-9]|[12]\\d|3[01])$') THEN NULL\n    ELSE\n      CASE\n        WHEN DATE_DIFF(CURRENT_DATE(), DATE(birthday), YEAR)\n               - CASE\n                   WHEN FORMAT_DATE('%m%d', DATE(birthday)) > FORMAT_DATE('%m%d', CURRENT_DATE()) THEN 1\n                   ELSE 0\n                 END > 18 THEN TRUE\n        ELSE FALSE\n      END\n  END AS over_18,\n  STRUCT(\n    country_code AS country,\n    continent\n  ) AS address,\n  is_verified,\n  email_marketing_preference,\n  news_subscription_group,\n  partners_subscription_group,\n  ticketing_subscription_group,\n  womens_subscription_group,\n  TRUE AS is_fusionauth_source,\n  FALSE AS is_historical,\n  FORMAT_TIMESTAMP('%Y-%m-%dT%H:%M:%S.%3SZ', last_update_ts) AS last_updated_ts,\n  FORMAT_TIMESTAMP('%Y-%m-%dT%H:%M:%S.%3SZ', CURRENT_TIMESTAMP()) AS last_modified_ts\nFROM clean_extract\nINNER JOIN emails_with_only_one_sso_id\n  ON emails_with_only_one_sso_id.email = clean_extract.email;"
  query_identifier_column = "event_id"
  source_id               = "kixWD3f5KF2FzFz9UiGVMB"
}