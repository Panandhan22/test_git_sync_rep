import {
  to = segment_function.id-ifnd_6912db6af40532066b68fc5b
  id = "ifnd_6912db6af40532066b68fc5b"
}

resource "segment_function" "id-ifnd_6912db6af40532066b68fc5b" {
  code          = "/**\n * Handle an \"identify\" event by mapping and transforming traits according to pre-defined format.\n *\n * @param {Object} event - The \"identify\" event object containing user traits.\n * @param {Object} settings - Configuration settings of the event.\n * @returns {Promise<void>} event - The event object must be returned to complete processing by Segment.\n */\nasync function onIdentify(event, settings) {\n\tconst rentStartDate = event.traits.rent_start_date;\n\tconst rentEndDate = event.traits.rent_end_date;\n\tconst bookingSnapshotStartDate = event.traits.booking_snapshot_start_date;\n\tconst bookingSnapshotEndDate = event.traits.booking_snapshot_end_date;\n\n\tlet personTraits;\n\tpersonTraits = await fetchTraits(event.anonymousId, settings);\n\tfor (const traitKey in personTraits) {\n\t\tif (!event.traits.hasOwnProperty(traitKey)) {\n\t\t\tevent.traits[traitKey] = personTraits[traitKey];\n\t\t}\n\t}\n\n\tif (rentStartDate) {\n\t\tevent.traits.us_rent_start_date = rentStartDate;\n\t\tevent.traits.eu_rent_start_date = rentStartDate;\n\t\tdelete event.traits.rent_start_date;\n\t}\n\n\tif (rentEndDate) {\n\t\tevent.traits.us_rent_end_date = rentEndDate;\n\t\tevent.traits.eu_rent_end_date = rentEndDate;\n\t\tdelete event.traits.rent_end_date;\n\t}\n\n\tif (bookingSnapshotStartDate) {\n\t\tevent.traits.us_booking_snapshot_start_date = bookingSnapshotStartDate;\n\t\tevent.traits.eu_booking_snapshot_start_date = bookingSnapshotStartDate;\n\t\tdelete event.traits.booking_snapshot_start_date;\n\t}\n\n\tif (bookingSnapshotEndDate) {\n\t\tevent.traits.us_booking_snapshot_end_date = bookingSnapshotEndDate;\n\t\tevent.traits.eu_booking_snapshot_end_date = bookingSnapshotEndDate;\n\t\tdelete event.traits.booking_snapshot_end_date;\n\t}\n\n\t/**\n\t * In the case where both rent_order_status and booking_snapshot_order_status\n\t * are available as traits, we should give priority to booking_snapshot_order_status.\n\t */\n\tif (event.traits.booking_snapshot_order_status) {\n\t\tdelete event.traits.rent_order_status;\n\t}\n\n\tfor (let incomingRequestKey in event.traits) {\n\t\tconst masterTrait = MASTER_TRAIT_NAMES[incomingRequestKey.toUpperCase()];\n\n\t\tif (!masterTrait) {\n\t\t\tif (incomingRequestKey !== 'email') {\n\t\t\t\tconsole.log(`Trait \"$${incomingRequestKey}\" is not mapped.`);\n\t\t\t}\n\t\t} else {\n\t\t\tconst { mailchimpKey, traitName } = masterTrait;\n\t\t\tif (incomingRequestKey === traitName) {\n\t\t\t\tevent.traits[mailchimpKey] = event.traits[incomingRequestKey];\n\t\t\t\tdelete event.traits[incomingRequestKey];\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * The email field is required for this event to be processed by the Mailchimp destination.\n\t * This data can be retrieved by calling Segment's Profile API using the anonymousId.\n\t */\n\tif (personTraits && personTraits.email) {\n\t\tevent.traits.email = personTraits.email;\n\t}\n\n\treturn event;\n}\n\n/**\n * Fetch the user's profile from the Segment Profile API. Generic function that can be used for multiple use-cases.\n *\n * @param anonymousId\n * @param {FunctionSettings} settings\n * @returns {any}\n */\nasync function fetchTraits(anonymousId, settings) {\n\tconst allTraitNames = getAllTraitNames();\n\n\tconst spaceId = 'spa_7pad4U4ZCmdZAUx9iGAMFB';\n\tconst profileUrl = `https://profiles.euw1.segment.com/v1/spaces/$${spaceId}/collections/users/profiles/anonymous_id:$${anonymousId}/traits?include=email,$${allTraitNames}`;\n\tconst profileApiAuthHeaders = {\n\t\tAuthorization: 'Basic ' + btoa(settings.token + ':')\n\t};\n\n\tconst fetchFromPersonas = await fetch(profileUrl, {\n\t\tmethod: 'GET',\n\t\theaders: profileApiAuthHeaders\n\t});\n\n\tif (fetchFromPersonas.status === 404) {\n\t\t/* If the user isn't found, return an empty profile object */\n\t\treturn {};\n\t} else if (\n\t\t/* Check if profile API returns a 5xx or 429; retry these errors */\n\t\tfetchFromPersonas.status >= 500 ||\n\t\tfetchFromPersonas.status === 429\n\t) {\n\t\tthrow new RetryError(\n\t\t\t'Profile API Error: ' +\n\t\t\t\tfetchFromPersonas.status +\n\t\t\t\t'. Segment will retry these requests up to 9 times over a four hour period, with exponential backoff. For more information, visit https://segment.com/docs/personas/profile-api/#errors.'\n\t\t);\n\t} else if (\n\t\t/* Check if profile API returns a 4xx error that is not 429 or 404; do not retry these errors */\n\t\tfetchFromPersonas.status < 500 &&\n\t\tfetchFromPersonas.status > 399 &&\n\t\tfetchFromPersonas.status !== 429 &&\n\t\tfetchFromPersonas.status !== 404\n\t) {\n\t\tthrow new Error(\n\t\t\t'Profile API Error: ' +\n\t\t\t\tfetchFromPersonas.status +\n\t\t\t\t'. User does not exist or Profile API credentials are incorrect. Segment will not retry these requests. For more information, visit https://segment.com/docs/personas/profile-api/#errors.'\n\t\t);\n\t}\n\tlet profileApiResponse = await fetchFromPersonas.json();\n\treturn profileApiResponse.traits || {};\n}\n\nfunction getAllTraitNames() {\n\tconst traitNames = Object.values(MASTER_TRAIT_NAMES).map(\n\t\ttrait => trait.traitName\n\t);\n\treturn traitNames.join(', ');\n}\n\nconst MASTER_TRAIT_NAMES = {\n\tRENT_ORDER_DATE: {\n\t\ttraitName: 'rent_order_date',\n\t\tmailchimpKey: 'REORDERDAT'\n\t},\n\tSPOTS_ORDER_DATE: {\n\t\ttraitName: 'spots_order_date',\n\t\tmailchimpKey: 'SPORDERDAT'\n\t},\n\tABO_ORDER_DATE: {\n\t\ttraitName: 'abo_order_date',\n\t\tmailchimpKey: 'ABORDERDAT'\n\t},\n\tSALES_ORDER_DATE: {\n\t\ttraitName: 'sales_order_date',\n\t\tmailchimpKey: 'SAORDERDAT'\n\t},\n\tRENT_ORDER_STATUS: {\n\t\ttraitName: 'rent_order_status',\n\t\tmailchimpKey: 'BSORDERSTA'\n\t},\n\tBOOKING_SNAPSHOT_ORDER_STATUS: {\n\t\ttraitName: 'booking_snapshot_order_status',\n\t\tmailchimpKey: 'BSORDERSTA'\n\t},\n\tSPOTS_ORDER_STATUS: {\n\t\ttraitName: 'spots_order_status',\n\t\tmailchimpKey: 'SPORDERSTA'\n\t},\n\tABO_ORDER_STATUS: {\n\t\ttraitName: 'abo_order_status',\n\t\tmailchimpKey: 'ABORDERSTA'\n\t},\n\tSALES_ORDER_STATUS: {\n\t\ttraitName: 'sales_order_status',\n\t\tmailchimpKey: 'SAORDERSTA'\n\t},\n\tEU_RENT_START_DATE: {\n\t\ttraitName: 'eu_rent_start_date',\n\t\tmailchimpKey: 'EUBSSTARTD'\n\t},\n\tUS_RENT_START_DATE: {\n\t\ttraitName: 'us_rent_start_date',\n\t\tmailchimpKey: 'USBSSTARTD'\n\t},\n\tEU_RENT_END_DATE: {\n\t\ttraitName: 'eu_rent_end_date',\n\t\tmailchimpKey: 'EUBSENDDAT'\n\t},\n\tUS_RENT_END_DATE: {\n\t\ttraitName: 'us_rent_end_date',\n\t\tmailchimpKey: 'USBSENDDAT'\n\t},\n\tEU_BOOKING_SNAPSHOT_START_DATE: {\n\t\ttraitName: 'eu_booking_snapshot_start_date',\n\t\tmailchimpKey: 'EUBSSTARTD'\n\t},\n\tUS_BOOKING_SNAPSHOT_START_DATE: {\n\t\ttraitName: 'us_booking_snapshot_start_date',\n\t\tmailchimpKey: 'USBSSTARTD'\n\t},\n\tEU_BOOKING_SNAPSHOT_END_DATE: {\n\t\ttraitName: 'eu_booking_snapshot_end_date',\n\t\tmailchimpKey: 'EUBSENDDAT'\n\t},\n\tUS_BOOKING_SNAPSHOT_END_DATE: {\n\t\ttraitName: 'us_booking_snapshot_end_date',\n\t\tmailchimpKey: 'USBSENDDAT'\n\t},\n\tSPOTS_START_DATE: {\n\t\ttraitName: 'spots_start_date',\n\t\tmailchimpKey: 'SPSTARTDAT'\n\t},\n\tABO_START_DATE: {\n\t\ttraitName: 'abo_start_date',\n\t\tmailchimpKey: 'ABSTARTDAT'\n\t},\n\tSPOTS_END_DATE: {\n\t\ttraitName: 'spots_end_date',\n\t\tmailchimpKey: 'SPENDDATE'\n\t},\n\tABO_END_DATE: {\n\t\ttraitName: 'abo_end_date',\n\t\tmailchimpKey: 'ABENDDATE'\n\t},\n\tRENT_PICKUP_TIME: {\n\t\ttraitName: 'rent_pickup_time',\n\t\tmailchimpKey: 'BSPICKUPTI'\n\t},\n\tBOOKING_SNAPSHOT_PICKUP_TIME: {\n\t\ttraitName: 'booking_snapshot_pickup_time',\n\t\tmailchimpKey: 'BSPICKUPTI'\n\t},\n\tRENT_DROP_OFF_TIME: {\n\t\ttraitName: 'rent_drop_off_time',\n\t\tmailchimpKey: 'BSDROPOFFT'\n\t},\n\tBOOKING_SNAPSHOT_DROP_OFF_TIME: {\n\t\ttraitName: 'booking_snapshot_drop_off_time',\n\t\tmailchimpKey: 'BSDROPOFFT'\n\t},\n\tRENT_STATION_NAME: {\n\t\ttraitName: 'rent_station_name',\n\t\tmailchimpKey: 'BSSTATIONN'\n\t},\n\tBOOKING_SNAPSHOT_STATION_NAME: {\n\t\ttraitName: 'booking_snapshot_station_name',\n\t\tmailchimpKey: 'BSSTATIONN'\n\t},\n\tABO_STATION_NAME: {\n\t\ttraitName: 'abo_station_name',\n\t\tmailchimpKey: 'ABSTATION'\n\t},\n\tRALLYE_STATION_NAME: {\n\t\ttraitName: 'rallye_station_name',\n\t\tmailchimpKey: 'RASTATION'\n\t},\n\tRENT_STATION_COUNTRY: {\n\t\ttraitName: 'rent_station_country',\n\t\tmailchimpKey: 'BSSTATIONC'\n\t},\n\tBOOKING_SNAPSHOT_STATION_COUNTRY: {\n\t\ttraitName: 'booking_snapshot_station_country',\n\t\tmailchimpKey: 'BSSTATIONC'\n\t},\n\tABO_STATION_COUNTRY: {\n\t\ttraitName: 'abo_station_country',\n\t\tmailchimpKey: 'ABSTATIONC'\n\t},\n\tRALLYE_STATION_COUNTRY: {\n\t\ttraitName: 'rallye_station_country',\n\t\tmailchimpKey: 'RASTATIONC'\n\t},\n\tRALLYE_RETURN_STATION_NAME: {\n\t\ttraitName: 'rallye_return_station_name',\n\t\tmailchimpKey: 'RARETURNNA'\n\t},\n\tRALLYE_RETURN_STATION_COUNTRY: {\n\t\ttraitName: 'rallye_return_station_country',\n\t\tmailchimpKey: 'RARETURNCO'\n\t},\n\tRENT_CAMPER_NAME: {\n\t\ttraitName: 'rent_camper_name',\n\t\tmailchimpKey: 'BSCAMPERNA'\n\t},\n\tBOOKING_SNAPSHOT_CAMPER_NAME: {\n\t\ttraitName: 'booking_snapshot_camper_name',\n\t\tmailchimpKey: 'BSCAMPERNA'\n\t},\n\tABO_CAMPER_NAME: {\n\t\ttraitName: 'abo_camper_name',\n\t\tmailchimpKey: 'ABCAMPERNA'\n\t},\n\tUSER_ACCOUNT_LINK: {\n\t\ttraitName: 'user_account_link',\n\t\tmailchimpKey: 'USERACCOUN'\n\t},\n\tTUTORIAL_COMPLETED: {\n\t\ttraitName: 'tutorial_completed',\n\t\tmailchimpKey: 'TUTCOMPLET'\n\t},\n\tRENT_DRIVER_DATA_COMPLETED: {\n\t\ttraitName: 'rent_driver_data_completed',\n\t\tmailchimpKey: 'REDRIVERDA'\n\t},\n\tABO_DRIVER_DATA_COMPLETED: {\n\t\ttraitName: 'abo_driver_data_completed',\n\t\tmailchimpKey: 'ABDRIVERDA'\n\t},\n\tSPOTS_CAMPFIRE_CARD_PURCHASED: {\n\t\ttraitName: 'spots_campfire_card_purchased',\n\t\tmailchimpKey: 'SPCAMPFIRE'\n\t},\n\tSPOT_LOCATION: {\n\t\ttraitName: 'spot_location',\n\t\tmailchimpKey: 'SPLOCATION'\n\t},\n\tSPOT_LOCATION_CITY: {\n\t\ttraitName: 'spot_location_city',\n\t\tmailchimpKey: 'SPCITYLOCA'\n\t},\n\tSPOT_LOCATION_COUNTRY: {\n\t\ttraitName: 'spot_location_country',\n\t\tmailchimpKey: 'SPCOUNTRYL'\n\t},\n\tSPOT_LOCATION_STATE: {\n\t\ttraitName: 'spot_location_state',\n\t\tmailchimpKey: 'SPSTATELOC'\n\t},\n\tSPOT_NAME: {\n\t\ttraitName: 'spot_name',\n\t\tmailchimpKey: 'SPOTNAME'\n\t},\n\tUSER_PRODUCT_INTEREST_INTENTION: {\n\t\ttraitName: 'user_product_interest_intention',\n\t\tmailchimpKey: 'USERPRODUC'\n\t},\n\tUSER_CAMPAIGN: {\n\t\ttraitName: 'user_campaign',\n\t\tmailchimpKey: 'USERCAMPAI'\n\t},\n\tSALES_EVENTS_DATE_STATION: {\n\t\ttraitName: 'sales_events_date_station',\n\t\tmailchimpKey: 'SAEVENTDAS'\n\t},\n\tOPTIN_STATUS: {\n\t\ttraitName: 'optin_status',\n\t\tmailchimpKey: 'OPTINSTATU'\n\t},\n\tCOUNTRY_FORM: {\n\t\ttraitName: 'country_form',\n\t\tmailchimpKey: 'COUNTRYFOR'\n\t},\n\tCAMPFIRE_CARD_EXTRA_BF: {\n\t\ttraitName: 'campfire_card_extra_bf',\n\t\tmailchimpKey: 'RECFCEXTRA'\n\t},\n\tORDER_CURRENCY: {\n\t\ttraitName: 'order_currency',\n\t\tmailchimpKey: 'ORDERCURRE'\n\t},\n\tRENT_BOOKING_ID: {\n\t\ttraitName: 'rent_booking_id',\n\t\tmailchimpKey: 'REBOOKID'\n\t}\n};\n"
  description   = null
  display_name  = null
  logo_url      = "https://cdn.filepicker.io/api/file/RmPmpcBTQZKaFeGQrdG5"
  resource_type = "INSERT_DESTINATION"
  settings = [
  ]
}