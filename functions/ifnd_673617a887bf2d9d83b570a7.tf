import {
  to = segment_function.id-ifnd_673617a887bf2d9d83b570a7
  id = "ifnd_673617a887bf2d9d83b570a7"
}

resource "segment_function" "id-ifnd_673617a887bf2d9d83b570a7" {
  code          = "async function onTrack(event, settings) {\n\t// Start log for debugging\n\tconsole.log('Starting onTrack function with event:', JSON.stringify(event));\n\n\ttry {\n\t\t// Fetch traits and ensure first_name is included in properties\n\t\tlet traits = await formatTraits(event, settings);\n\t\tconsole.log('Traits fetched:', JSON.stringify(traits));\n\n\t\t// Merge traits into event properties\n\t\t_.merge(event.properties, traits);\n\t\tconsole.log(\n\t\t\t'Event properties after merging traits:',\n\t\t\tJSON.stringify(event.properties)\n\t\t);\n\n\t\t// Explicitly set first_name in properties if not already present\n\t\tif (!event.properties.first_name && traits.first_name) {\n\t\t\tevent.properties.first_name = traits.first_name;\n\t\t\tconsole.log(\n\t\t\t\t'First name explicitly set in properties:',\n\t\t\t\tevent.properties.first_name\n\t\t\t);\n\t\t}\n\n\t\t// Log the final payload to verify first_name inclusion\n\t\tconsole.log('Final event payload for Track:', JSON.stringify(event));\n\n\t\treturn event;\n\t} catch (error) {\n\t\tconsole.error('Error in onTrack function:', error);\n\t\tthrow error;\n\t}\n}\n\n/**\n * Handle identify event\n * @param  {SegmentIdentifyEvent} event\n * @param  {FunctionSettings} settings\n */\nasync function onIdentify(event, settings) {\n\t// Start log for debugging\n\tconsole.log(\n\t\t'Starting onIdentify function with event:',\n\t\tJSON.stringify(event)\n\t);\n\n\ttry {\n\t\t// Fetch traits and ensure first_name is included in traits\n\t\tlet traits = await formatTraits(event, settings);\n\t\tconsole.log('Traits fetched:', JSON.stringify(traits));\n\n\t\t// Merge traits into event traits\n\t\t_.merge(event.traits, traits);\n\t\tconsole.log(\n\t\t\t'Event traits after merging traits:',\n\t\t\tJSON.stringify(event.traits)\n\t\t);\n\n\t\t// Explicitly set first_name in traits if not already present\n\t\tif (!event.traits.first_name && traits.first_name) {\n\t\t\tevent.traits.first_name = traits.first_name;\n\t\t\tconsole.log(\n\t\t\t\t'First name explicitly set in traits:',\n\t\t\t\tevent.traits.first_name\n\t\t\t);\n\t\t}\n\n\t\t// Log the final payload to verify first_name inclusion\n\t\tconsole.log('Final event payload for Identify:', JSON.stringify(event));\n\n\t\treturn event;\n\t} catch (error) {\n\t\tconsole.error('Error in onIdentify function:', error);\n\t\tthrow error;\n\t}\n}\n\n/*----- Helper Functions Start -----*/\n\n// Handle event if identify or track\nasync function formatTraits(event, settings) {\n\tconsole.log('Starting formatTraits function');\n\n\tconst { profileApiKey, profileTraitsToFetch } = settings;\n\tlet spaceId = settings.spaceId;\n\tlet traitKeys = _.keysIn(profileTraitsToFetch);\n\n\t// Determine the identifier to use (userId or anonymousId)\n\tlet identifierKey =\n\t\tevent.userId && event.userId !== 'NULL' ? 'user_id' : 'anonymous_id';\n\tlet identifier =\n\t\tevent.userId && event.userId !== 'NULL' ? event.userId : event.anonymousId;\n\n\tconsole.log(`Using identifier: $${identifierKey} = $${identifier}`);\n\n\ttry {\n\t\tlet profileResult = await fetchProfileTraits(\n\t\t\tidentifierKey,\n\t\t\tidentifier,\n\t\t\tprofileApiKey,\n\t\t\tspaceId,\n\t\t\ttraitKeys\n\t\t);\n\t\tconsole.log(\n\t\t\t'Profile result from fetchProfileTraits:',\n\t\t\tJSON.stringify(profileResult)\n\t\t);\n\n\t\t// Enter traits to use to enrich event properties with, ensuring first_name is included\n\t\tlet traits = {\n\t\t\tfirst_name: profileResult.first_name || null // Ensure first_name is set to null if not found\n\t\t};\n\t\t_.forEach(traitKeys, key => {\n\t\t\t_.set(traits, profileTraitsToFetch[key], profileResult[key]);\n\t\t});\n\t\tconsole.log('Final traits object:', JSON.stringify(traits));\n\n\t\treturn traits;\n\t} catch (error) {\n\t\tconsole.error('Error in formatTraits function:', error);\n\t\tthrow error;\n\t}\n}\n\n// Fetch traits from profile API - https://segment.com/docs/profiles/profile-api/\nasync function fetchProfileTraits(\n\tidentifierKey,\n\tidentifier,\n\tprofileApiKey,\n\tspaceId,\n\ttraitsToFetch\n) {\n\tconsole.log('Starting fetchProfileTraits function');\n\n\tlet endpoint = `https://profiles.segment.com/v1/spaces/$${spaceId}/collections/users/profiles/$${identifierKey}:$${identifier}/traits?limit=200&include=$${traitsToFetch.join(\n\t\t`,`\n\t)}`;\n\tconsole.log('API endpoint:', endpoint);\n\n\ttry {\n\t\t// GET profile traits\n\t\tlet response = await fetch(endpoint, {\n\t\t\tmethod: 'GET',\n\t\t\theaders: {\n\t\t\t\tAuthorization: `Basic $${btoa(profileApiKey + ':')}`,\n\t\t\t\t'Content-Type': `application/json`\n\t\t\t}\n\t\t});\n\n\t\tif (response.ok) {\n\t\t\tconsole.log(\n\t\t\t\t'Profile API call successful:',\n\t\t\t\tresponse.status,\n\t\t\t\tresponse.statusText\n\t\t\t);\n\t\t} else if (response.status === 429 || response.status >= 500) {\n\t\t\tconsole.log(\n\t\t\t\t'Profile API error with retry:',\n\t\t\t\tresponse.status,\n\t\t\t\tresponse.statusText\n\t\t\t);\n\t\t\tthrow new RetryError(\n\t\t\t\t`Profile API retry error. GET $${endpoint} = $${response.status} $${response.statusText}`\n\t\t\t);\n\t\t} else {\n\t\t\tconsole.log(\n\t\t\t\t'Profile API error without retry:',\n\t\t\t\tresponse.status,\n\t\t\t\tresponse.statusText\n\t\t\t);\n\t\t\tthrow new Error(\n\t\t\t\t`Profile API error. GET $${endpoint} = $${response.status} $${response.statusText}`\n\t\t\t);\n\t\t}\n\n\t\tlet responseData = await response.json();\n\t\tconsole.log(\n\t\t\t'Response data from Profile API:',\n\t\t\tJSON.stringify(responseData)\n\t\t);\n\n\t\treturn responseData.traits;\n\t} catch (error) {\n\t\tconsole.error('Error in fetchProfileTraits function:', error);\n\t\tthrow error;\n\t}\n}\n\n/*----- Helper Functions End -----*/\n"
  description   = null
  display_name  = null
  logo_url      = "https://cdn.filepicker.io/api/file/RmPmpcBTQZKaFeGQrdG5"
  resource_type = "INSERT_DESTINATION"
  settings = [
    {
      description = ""
      label       = "profile_api_key"
      name        = "profileApiKey"
      required    = true
      sensitive   = false
      type        = "STRING"
    },
    {
      description = ""
      label       = "space_id"
      name        = "spaceId"
      required    = true
      sensitive   = false
      type        = "STRING"
    },
  ]
}